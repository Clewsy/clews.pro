<!DOCTYPE html>
<html>
	<head>
		<title>clews.pro</title>
		<link href="/css/style.css" type="text/css" rel="stylesheet" />
	</head>
	<body>
		<script src="/js/header_common.js"></script>
<!-- Above here can be copied for a consistent header across pages -->
		<div id="page">
			<h2 class="align-center">ncbu</h2>
			<a href="https://hub.docker.com/"><img class="image align-left" src="photos/ncbu_1.png" alt="Dockerhub" /></a>
			<h3>Description:</h3>
			<p>ncbu - or NextCloud Back-Up - is a docker container image created to simplify and automate perodic physical snapshots of a self-hosted nextcloud service.  The snapshots serve as a backup of the nextcloud volume and also (if applicable) the nextcloud database volume.</p>
			<p>The intention is to run this image as a container alongside the nextcloud app and database containers.  Management of the "live" nextcloud/database volumes can therefore be left to docker.  When the ncbu back-up script is initialised, it first locks the nextcloud instance (i.e. puts nextcloud into maintenance mode) before syncing the volumes to a user-defined location.  Once complete, the script unlocks nextcloud so that normal usage can resume.</p>
			<p>By locking nextcloud first, ncbu ensures that the backup is effectively a "snapshot" of the nextcloud and database volumes.</p>
			<h3>Why?:</h3>
			<p>I discovered docker on my journey to rid myself of cloud-based services not within my control.  A docker implementation of nextcloud is great for robustness and portability.  It also facillitated simple back-ups by binding the data volumes to a user-accessible directory.  Initially I set up an rsync cronjob to automate my backups and this was fine, but I saw potential benefits in containerising the backup service.  Mostly, I wanted to have a go at learning docker and creating my own container image.</p>
			<p>Now my backup automation is implmented simultaneously alongside the nextcloud and database containers thanks to docker-compose and a single *.yml file.  Refer to my <a href="/projects/clews.html">clews.pro</a> project for more information of my self-hosting implementation.</p>
			<a href="https://nextcloud.com/"><img class="image align-right" src="photos/ncbu_2.png" alt="Nextcloud" /></a>
			<h3>What:</h3>
			<p>Once it is spun up, provided the correct environment variables and volumes are defined, the ncbu will run an initialisation script (ncbu_init.sh) to do some basic error-checking, then it will simply kick off cron in the foreground.  There is a single cron job set (at a user-defined time, midnight every dy by default) which will execute the backup script.</p>
			<p>The backup script (ncbu.sh) will first put the nextcloud instance into maintenance mode, effectively "freezing" the nextcloud data files and database.  Rsync is then used to copy all of the files from the nextcloud and database volumes to a backup directory.  Once complete, maintenance mode is disabled.</p>
			<p>A third script within the container (ncbu_restore.sh) is used to restore nextcloud and database containers from a stored backup.  The restore script can only be run manually by the user.  It will similarly put nextcloud into maintenance mode and then sync all the nextcloud and database files in the reverse direction before exiting maintenance mode.  The restore script will also initialise a scan of the data files and update the database accordingly - this helps if the user is "restoring" to a new host.</p>
			<h3>How:</h3>
			<p>The following commands may be useful, but much more detail can be found at the <a href="https://gitlab.com/clewsy/ncbu">gitlab</a> or <a href="https://hub.docker.com/r/ncbu/ncbu">dockerhub</a> repositories.</p>
			<h4>Create the container:</h4>
			<p>Build from source:</p>
			<p class="code">$ git clone git@gitlab.com:clewsy/ncbu<br/>
				$ cd ncbu<br/>
				$ docker build -t ncbu/ncbu .</p>
			<p>Pull from dockerhub:</p>
			<p class="code">$ docker pull clewsy/ncbu</p>
			<h4>Run the container:</h4>
			<p>Run using the <i>docker run</i> command:</p>
			<p class="code">$ docker run -ti \<br/>
				-h ncbu \<br/>
				-e NEXTCLOUD_CONTAINER=nextcloud-app \<br/>
				-e NEXTCLOUD_DATABASE_CONTAINER=nextcloud-db \<br/>		
				-e NEXTCLOUD_BACKUP_CRON="0 0 * * *" \<br/>
				-v /etc/localtime:/etc/localtime:ro \<br/>
				-v /var/run/docker.sock:/var/run/docker.sock:ro \<br/>
				-v nextcloud-app:/mnt/nextcloud-app \<br/>			
				-v nextcloud-db:/mnt/nextcloud-db \<br/>
				-v ./nextcloud-bu:/backup \<br/>
				clewsy/ncbu</p>
			<p>Alternatively, it can be run using docker-compose.  Here is an <a href="https://gitlab.com/clewsy/clews.pro/blob/master/docker-compose.yml">example docker-compose.yml file</a>.</p>
			<h4>Initiate a manual backup:</h4>
			<p class="code">$ docker exec ncbu ncbu.sh</p>
			<h4>Initiate restoration from a backup:</h4>
			<p class="code">$ docker exec ncbu ncbu_restore.sh</p>
			<a class="align-center" href="/index.html"><img src="/images/clews_logo.png" title="Logo" width="100" /></a>
		</div>
	</body>
</html>
